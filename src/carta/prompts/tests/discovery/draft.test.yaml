- description: "Should draft a discovery document"
  provider:
    id: openrouter:openai/gpt-4.1-mini
    config:
      tools: file://src/carta/prompts/tests/tools/tools.yaml
      tool_choice: none
  vars:
    system_prompt: file://src/carta/prompts/discover/draft.md
    input: |
      [
        {
          "topic": "Scope",
          "question": "What types of users should be able to authenticate into the app?",
          "options": [
            {
              "description": "Only internal or predefined users",
              "impact": "Limits user base, simpler user management"
            },
            {
              "description": "Any external users with accounts",
              "impact": "Requires broader user registration and management"
            }
          ],
          "answer": "Only internal or predefined users"
        },
        {
          "topic": "Security and Privacy",
          "question": "Should the authentication process include multi-factor authentication (MFA)?",
          "options": [
            {
              "description": "No MFA, only username and password",
              "impact": "Simpler for users but less secure"
            },
            {
              "description": "Optional MFA for sensitive actions",
              "impact": "Improves security without burdening all users"
            },
            {
              "description": "Mandatory MFA for all users",
              "impact": "Provides highest security but adds user friction"
            }
          ],
          "answer": "No MFA, only username and password"
        },
        {
          "topic": "User Experience",
          "question": "Should users be able to reset or recover their passwords if lost?",
          "options": [
            {
              "description": "No password recovery",
              "impact": "Simplifies system but may frustrate users"
            },
            {
              "description": "Allow recovery via email or other methods",
              "impact": "Improves user experience but requires secure recovery flows"
            }
          ],
          "answer": "Allow recovery via email or other methods"
        },
        {
          "topic": "Scope",
          "question": "Should users be allowed to stay signed in across sessions (remember me functionality)?",
          "options": [
            {
              "description": "No, require login each session",
              "impact": "Increases security but may reduce convenience"
            },
            {
              "description": "Yes, allow persistent sessions",
              "impact": "Improves UX but needs secure session management"
            }
          ],
          "answer": "Yes, allow persistent sessions"
        }
      ]
  threshold: 1
  assert:
    - type: llm-rubric
      provider:
        id: openrouter:openai/gpt-4.1-mini
      value: |
        The draft discovery document should have the following sections:

        **Objective**: [What needs accomplishing]
        **Context**: [Why needed, business impact]
        **Assumptions**: [Reasonable defaults]
        **Constraints**: [Technical and business limitations]
        **Acceptance Criteria**: [Verifiable, testable conditions]
        **User Scenarios**: [Step-by-step flows with expected outcomes]
        **Edge Cases**: [Boundary conditions]
        **Dependencies** *(if applicable)*: [External requirements]
        **Out of Scope**: [Explicitly excluded]

        PASS if: The draft discovery document has all the sections and the sections are complete.
        FAIL if: The draft discovery document is missing any of the sections or the sections are incomplete.

    - type: llm-rubric
      provider:
        id: openrouter:openai/gpt-4.1-mini
      value: |
        The draft discovery document should not include any technology choices, API designs, or code structure.

        PASS if: The draft discovery document does not include any technology choices, API designs, or code structure.
        FAIL if: The draft discovery document includes any technology choices, API designs, or code structure.

    - type: llm-rubric
      provider:
        id: openrouter:openai/gpt-4.1-mini
      value: |
        The draft discovery document should not include any assumptions about the project not supported by either the context, user description, or the questions and answers.

        PASS if: The draft discovery document does not include any assumptions about the project not supported by either the context, user description, or the questions and answers.
        FAIL if: The draft discovery document includes any assumptions about the project not supported by either the context, user description, or the questions and answers.

    - type: llm-rubric
      provider:
        id: openrouter:openai/gpt-4.1-mini
      value: |
        The Context section should incorporate specific trade-offs or impacts mentioned in the Q&A answers, not generic statements like "improving efficiency" or "reducing errors".

        For example, if an answer's impact mentions "simpler user management" or "less secure", those trade-offs should inform the Context.

        PASS if: The Context section references specific trade-offs or constraints from the Q&A answer impacts.
        FAIL if: The Context section uses only generic business justifications not traceable to the Q&A.

    - type: llm-rubric
      provider:
        id: openrouter:openai/gpt-4.1-mini
      value: |
        User Scenarios should describe realistic situations with user context (who the user is, what they're trying to accomplish), not just procedural command flows.

        Good: "An internal employee returns to the app after lunch and is still logged in due to persistent sessions."
        Bad: "User opens app → User is authenticated → Session is valid."

        PASS if: At least half of the User Scenarios include realistic user context or motivation.
        FAIL if: User Scenarios are purely procedural step lists without user context.
